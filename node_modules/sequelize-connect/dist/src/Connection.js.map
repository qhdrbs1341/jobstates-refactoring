{"version":3,"sources":["../../src/Connection.js"],"names":["instance","Connection","database","username","password","options","discover","matcher","logger","models","Sequelize","_connect","then","connection","_log","sequelize","dir","discoverable","Discoverable","each","path","model","name","Promise","Object","keys","modelName","associate","sync","level","message","log","module","exports"],"mappings":"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","file":"Connection.js","sourcesContent":["\"use strict\";\n\nimport Promise from \"bluebird\";\nimport path from \"path\";\nimport Sequelize from \"sequelize\";\nimport Discoverable  from \"./Discoverable\";\n\n// Setup Logger\n// logger.level  = \"info\";   // Default log level to debug\n\nlet instance = null;\n\nclass Connection {\n\n  constructor(database, username, password, options={}, discover=[\"/model\"], matcher=null, logger=false) {\n\n    if(instance) return instance;\n\n    this.database = database;\n    this.username = username;\n    this.password = password;\n    this.options = options;\n    this.discover = discover; // Set the default discovery paths to [\"/model\"]\n    this.matcher = matcher; // Set the default matcher to null\n    this.logger = logger;\n\n    // Expose db\n    this.models = {};\n    this.Sequelize = Sequelize; // Expose Sequelize\n\n    instance = this._connect();\n\n    return instance\n      .then((connection) => {\n        return instance = connection;\n      });\n  }\n\n  /**\n   * Connect to the db\n   * @return {Object} A database object containing sequelize and models\n   */\n  _connect(){\n\n    // return the instance, although this shouldn't be being called externally\n    if(instance) return instance;\n\n    this._log(\"info\", \"Connecting to: \" + this.database + \" as: \" + this.username);\n\n    // Instantiate a new sequelize instance\n    let sequelize = new this.Sequelize(this.database, this.username, this.password, this.options);\n    let models = {};\n\n\n    let dir = typeof this.discover === \"string\" ? [this.discover] : this.discover;\n    let discoverable = new Discoverable(dir, this.matcher, this.logger);\n\n    return discoverable.discover()\n      .each((path) => {\n        // Import each discovered path\n        let model  = sequelize[\"import\"](path);\n\n        if(model) {\n          this._log(\"debug\", \"Import for path succeeded: \" + path);\n          models[model.name] = model;\n        } else {\n          this._log(\"debug\", \"Import for path failed: \" + path);\n        }\n\n      })\n      .then((path) => {\n        // Execute the associate methods for each Model\n        this._log(\"info\",\"Import completed\");\n\n        return Promise.each(Object.keys(models), (modelName) => {\n\n          if (\"associate\" in models[modelName]) {\n            this._log(\"debug\", \"Associating Model: \"+ modelName);\n            models[modelName].associate(models);\n          } else {\n            this._log(\"debug\", \"Nothing to associate for Model: \"+ modelName);\n          }\n        });\n\n      })\n      .then(() => {\n        // Syncronize the DB\n        this._log(\"info\", \"Finished connecting to: \" + this.database + \" as: \" + this.username);\n        return sequelize.sync();\n\n      })\n      .then(() => {\n        this._log(\"info\", \"Finished synchronizing \" + this.database);\n        // Expose objects\n        this.sequelize = sequelize;\n        this.models    = models;\n\n        return this;\n      });\n  }\n\n  /**\n   * Attempt to log\n   * @param  {String} message Message to log\n   * @return {null}\n   */\n  _log(level, message){\n    this.logger ? this.logger.log(level, message) : false;\n  }\n}\n\nmodule.exports =  Connection;\n"]}